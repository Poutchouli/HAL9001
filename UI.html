import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { ShieldCheck, Database, Activity, Server, ChevronDown, ChevronUp, User, Key, CheckCircle, XCircle, AlertTriangle, Settings, LogOut, Bell } from 'lucide-react';

// --- MOCK DATA ---
// In a real application, this would come from an API
const MOCK_USERS = [
  { id: 'usr_001', name: 'Dave Bowman', role: 'Data Editor', email: 'd.bowman@discovery.co' },
  { id: 'usr_002', name: 'Frank Poole', role: 'Data Viewer', email: 'f.poole@discovery.co' },
  { id: 'usr_003', name: 'Admin User', role: 'Tenant Admin', email: 'admin@discovery.co' },
  { id: 'usr_004', name: 'System Architect', role: 'System Admin', email: 'sysarch@system.co' },
];

const MOCK_TABLES = [
  'crew_vitals_log',
  'pod_bay_doors_status',
  'discovery_one_systems',
  'monolith_observations_secure',
  'mission_critical_data',
];

const MOCK_INITIAL_PERMISSIONS = {
  'usr_001': {
    'crew_vitals_log': { can_select: true, can_insert: true, can_update: true, can_delete: false },
    'pod_bay_doors_status': { can_select: true, can_insert: true, can_update: true, can_delete: false },
    'discovery_one_systems': { can_select: true, can_insert: false, can_update: false, can_delete: false },
  },
  'usr_002': {
    'crew_vitals_log': { can_select: true, can_insert: false, can_update: false, can_delete: false },
    'discovery_one_systems': { can_select: true, can_insert: false, can_update: false, can_delete: false },
  },
  'usr_003': {
    'crew_vitals_log': { can_select: true, can_insert: true, can_update: true, can_delete: true },
    'pod_bay_doors_status': { can_select: true, can_insert: true, can_update: true, can_delete: true },
    'discovery_one_systems': { can_select: true, can_insert: true, can_update: true, can_delete: true },
  },
};

// --- MAIN APP COMPONENT ---
export default function App() {
  return (
    <div className="bg-gray-100 text-gray-800 font-sans min-h-screen">
      <Header />
      <main className="p-4 sm:p-6 lg:p-8">
        <Dashboard />
      </main>
    </div>
  );
}

// --- LAYOUT COMPONENTS ---
const Header = () => (
  <header className="bg-white shadow-sm flex items-center justify-between p-4">
    <div className="flex items-center space-x-4">
      <div className="bg-blue-600 p-2 rounded-lg">
        <Database className="text-white h-6 w-6" />
      </div>
      <div>
        <h1 className="text-xl font-bold text-gray-900">HAL9001</h1>
        <p className="text-sm text-gray-500">Secure API Gateway</p>
      </div>
    </div>
    <div className="flex items-center space-x-4">
      <ApiStatusWidget />
      <button className="p-2 rounded-full hover:bg-gray-100">
        <Bell className="h-5 w-5 text-gray-600" />
      </button>
      <button className="p-2 rounded-full hover:bg-gray-100">
        <Settings className="h-5 w-5 text-gray-600" />
      </button>
      <div className="flex items-center space-x-2">
        <div className="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
            <User className="h-5 w-5 text-gray-600"/>
        </div>
        <span className="text-sm font-medium hidden sm:inline">Admin User</span>
      </div>
    </div>
  </header>
);

const Dashboard = () => (
  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div className="lg:col-span-2">
      <AccessControlWidget />
    </div>
    <div className="space-y-6">
      <SyncLogWidget />
      <DbOperationsWidget />
    </div>
  </div>
);

const Card = ({ icon, title, children, footer }) => {
  const [isOpen, setIsOpen] = useState(true);
  const IconComponent = icon;

  return (
    <div className="bg-white border border-gray-200 rounded-lg shadow-sm">
      <button
        className="w-full flex items-center justify-between p-4 text-left text-gray-700 hover:bg-gray-50 rounded-t-lg"
        onClick={() => setIsOpen(!isOpen)}
      >
        <div className="flex items-center space-x-3">
          <IconComponent className="w-5 h-5 text-blue-600" />
          <h2 className="text-lg font-semibold">{title}</h2>
        </div>
        {isOpen ? <ChevronUp className="w-5 h-5 text-gray-500" /> : <ChevronDown className="w-5 h-5 text-gray-500" />}
      </button>
      {isOpen && (
        <>
          <div className="p-4">
            {children}
          </div>
          {footer && <div className="p-4 bg-gray-50 border-t border-gray-200 rounded-b-lg text-xs text-gray-500">{footer}</div>}
        </>
      )}
    </div>
  );
};


// --- WIDGET COMPONENTS ---

const ApiStatusWidget = () => (
  <div className="flex items-center space-x-2 p-2 bg-green-100 border border-green-200 rounded-lg">
    <div className="relative flex items-center justify-center w-4 h-4">
      <div className="absolute w-full h-full bg-green-400 rounded-full animate-ping opacity-75"></div>
      <div className="w-2.5 h-2.5 bg-green-500 rounded-full"></div>
    </div>
    <span className="text-sm font-semibold text-green-800">API Online</span>
  </div>
);

const AccessControlWidget = () => {
  const [permissions, setPermissions] = useState(MOCK_INITIAL_PERMISSIONS);
  const [selectedUserId, setSelectedUserId] = useState(MOCK_USERS[0].id);

  const selectedUser = useMemo(() => MOCK_USERS.find(u => u.id === selectedUserId), [selectedUserId]);

  const handlePermissionChange = (tableName, perm, value) => {
    setPermissions(prev => {
      const userPerms = prev[selectedUserId] || {};
      const tablePerms = userPerms[tableName] || {};
      return {
        ...prev,
        [selectedUserId]: {
          ...userPerms,
          [tableName]: { ...tablePerms, [perm]: value },
        },
      };
    });
    // In a real app, this would trigger:
    // POST /api/v1/admin/permissions with { userId, tableName, permission, value }
  };

  const isChangeDisabled = selectedUser?.role !== 'System Admin' && selectedUser?.role !== 'Tenant Admin';

  const cardFooter = (
    <p>This interface manages the `user_table_permissions` table. Changes trigger API calls to update PostgreSQL RLS policies. Only Admins can modify permissions.</p>
  );

  return (
    <Card icon={ShieldCheck} title="Row-Level Security Policy Manager" footer={cardFooter}>
      <div className="space-y-4">
        <div>
          <label htmlFor="user-select" className="block text-sm font-medium text-gray-700 mb-1">Select User:</label>
          <select
            id="user-select"
            className="w-full p-2 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
            value={selectedUserId}
            onChange={(e) => setSelectedUserId(e.target.value)}
          >
            {MOCK_USERS.map(user => (
              <option key={user.id} value={user.id}>{user.name} ({user.role})</option>
            ))}
          </select>
        </div>
        <div className="overflow-x-auto border border-gray-200 rounded-lg">
          <table className="min-w-full text-sm text-left">
            <thead className="bg-gray-50 text-gray-600">
              <tr>
                <th className="p-3 font-semibold">Table Name</th>
                <th className="p-3 text-center font-semibold">SELECT</th>
                <th className="p-3 text-center font-semibold">INSERT</th>
                <th className="p-3 text-center font-semibold">UPDATE</th>
                <th className="p-3 text-center font-semibold">DELETE</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {MOCK_TABLES.map(table => {
                const userPerms = permissions[selectedUserId] || {};
                const tablePerms = userPerms[table] || {};
                return (
                  <tr key={table} className="hover:bg-gray-50">
                    <td className="p-3 font-medium text-gray-900">{table}</td>
                    {['can_select', 'can_insert', 'can_update', 'can_delete'].map(perm => (
                      <td key={perm} className="p-3 text-center">
                        <input
                          type="checkbox"
                          className="w-5 h-5 bg-gray-100 border-gray-300 rounded text-blue-600 focus:ring-blue-500 cursor-pointer disabled:cursor-not-allowed disabled:opacity-50"
                          checked={!!tablePerms[perm]}
                          onChange={(e) => handlePermissionChange(table, perm, e.target.checked)}
                          disabled={isChangeDisabled}
                        />
                      </td>
                    ))}
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>
    </Card>
  );
};

const SyncLogWidget = () => {
  const [logs, setLogs] = useState([]);

  const generateLog = useCallback(() => {
    const statuses = [
      { type: 'SUCCESS', icon: CheckCircle, color: 'text-green-500', message: 'Batch upsert successful.' },
      { type: 'CONFLICT', icon: AlertTriangle, color: 'text-yellow-500', message: 'Conflict detected. HLC mismatch.' },
      { type: 'ERROR', icon: XCircle, color: 'text-red-500', message: 'Invalid payload schema.' },
    ];
    const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
    const randomUser = MOCK_USERS[Math.floor(Math.random() * MOCK_USERS.length)];
    
    const newLog = {
      id: `log_${Date.now()}_${Math.random()}`,
      timestamp: new Date().toLocaleTimeString(),
      user: randomUser.name,
      status: randomStatus.type,
      Icon: randomStatus.icon,
      color: randomStatus.color,
      message: randomStatus.message,
    };

    setLogs(prev => [newLog, ...prev.slice(0, 14)]);
  }, []);

  useEffect(() => {
    const interval = setInterval(generateLog, 4000);
    generateLog(); // Initial log
    return () => clearInterval(interval);
  }, [generateLog]);
  
  const cardFooter = (
    <p>Monitoring real-time activity on the <strong>POST /api/v1/sync</strong> endpoint.</p>
  );

  return (
    <Card icon={Activity} title="Real-Time Sync Log" footer={cardFooter}>
      <div className="space-y-3 h-80 overflow-y-auto pr-2">
        {logs.map(log => (
          <div key={log.id} className="flex items-start space-x-3 text-xs animate-fade-in">
            <log.Icon className={`w-4 h-4 mt-0.5 flex-shrink-0 ${log.color}`} />
            <div className="flex-grow">
              <p className="font-semibold text-gray-800">
                <span className="font-normal text-gray-500 mr-2">{log.timestamp}</span>
                [{log.user}]
              </p>
              <p className={`text-gray-600`}>{log.status}: {log.message}</p>
            </div>
          </div>
        ))}
      </div>
    </Card>
  );
};

const DbOperationsWidget = () => {
  const [isCloning, setIsCloning] = useState(false);
  const [cloneStatus, setCloneStatus] = useState('');

  const handleClone = () => {
    setIsCloning(true);
    setCloneStatus('1/3: Initiating secure dump from production instance...');
    setTimeout(() => {
      setCloneStatus('2/3: Restoring dump to new staging instance...');
    }, 2000);
    setTimeout(() => {
      setCloneStatus('3/3: Running data sanitization scripts...');
    }, 4000);
    setTimeout(() => {
      setCloneStatus('Clone successful. Staging database is ready for use.');
      setIsCloning(false);
    }, 6000);
  };
  
  const cardFooter = (
    <p>Cloning creates a sanitized copy of the production database for development or testing.</p>
  );

  return (
    <Card icon={Database} title="Database Management" footer={cardFooter}>
      <div className="space-y-4">
        <p className="text-sm text-gray-600">Manually trigger a clone of the production database for staging or backup verification.</p>
        <button
          onClick={handleClone}
          disabled={isCloning}
          className="w-full flex items-center justify-center p-2 bg-blue-600 text-white font-bold rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
        >
          {isCloning ? 'Cloning in Progress...' : 'Create Database Clone'}
        </button>
        {cloneStatus && (
          <div className="text-sm text-blue-700 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <p><strong>Status:</strong> {cloneStatus}</p>
          </div>
        )}
      </div>
    </Card>
  );
};

// Add fade-in animation for better UX
const style = document.createElement('style');
style.innerHTML = `
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-in {
    animation: fadeIn 0.3s ease-out forwards;
  }
`;
document.head.appendChild(style);

