<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAL9001 - Secure API Gateway</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .animate-ping {
            animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite;
        }
        @keyframes ping {
            75%, 100% {
                transform: scale(2);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        const API_BASE_URL = 'http://localhost:8000';

        // Simple icon components (replacing Lucide React)
        const Database = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                <path d="M5 12c0 1.66 3.13 3 7 3s7-1.34 7-3"></path>
                <path d="M5 17c0 1.66 3.13 3 7 3s7-1.34 7-3"></path>
                <path d="M21 5v14c0 1.66-3.13 3-7 3s-7-1.34-7-3V5"></path>
            </svg>
        );

        const ShieldCheck = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M12 2L22 7v5c0 5.55-3.84 10.74-9 12-5.16-1.26-9-6.45-9-12V7l10-5z"></path>
                <path d="m9 12 2 2 4-4"></path>
            </svg>
        );

        const Activity = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="m22 12-4-4v3H14v2h4v3l4-4z"></path>
                <path d="M22 12h-6"></path>
                <path d="M22 12l-4-4"></path>
                <path d="M22 12l-4 4"></path>
                <path d="M2 12h6"></path>
                <path d="M2 12l4-4"></path>
                <path d="M2 12l4 4"></path>
            </svg>
        );

        const ChevronDown = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="6,9 12,15 18,9"></polyline>
            </svg>
        );

        const ChevronUp = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="18,15 12,9 6,15"></polyline>
            </svg>
        );

        const User = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
        );

        const Bell = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
        );

        const Settings = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V6a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        );

        const AlertTriangle = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
        );

        // --- MAIN APP COMPONENT ---
        function App() {
            return (
                <div className="bg-gray-100 text-gray-800 font-sans min-h-screen">
                    <Header />
                    <main className="p-4 sm:p-6 lg:p-8">
                        <Dashboard />
                    </main>
                </div>
            );
        }

        // --- WIDGET & LAYOUT COMPONENTS ---
        const Header = () => (
            <header className="bg-white shadow-sm flex items-center justify-between p-4">
                <div className="flex items-center space-x-4">
                    <div className="bg-blue-600 p-2 rounded-lg">
                        <Database className="text-white h-6 w-6" />
                    </div>
                    <div>
                        <h1 className="text-xl font-bold text-gray-900">HAL9001</h1>
                        <p className="text-sm text-gray-500">Secure API Gateway</p>
                    </div>
                </div>
                <div className="flex items-center space-x-4">
                    <ApiStatusWidget />
                    <button className="p-2 rounded-full hover:bg-gray-100">
                        <Bell className="h-5 w-5 text-gray-600" />
                    </button>
                    <button className="p-2 rounded-full hover:bg-gray-100">
                        <Settings className="h-5 w-5 text-gray-600" />
                    </button>
                    <div className="flex items-center space-x-2">
                        <div className="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                            <User className="h-5 w-5 text-gray-600"/>
                        </div>
                        <span className="text-sm font-medium hidden sm:inline">Admin User</span>
                    </div>
                </div>
            </header>
        );

        const Dashboard = () => (
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="lg:col-span-2"><AccessControlWidget /></div>
                <div className="space-y-6"><SyncLogWidget /><DbOperationsWidget /></div>
            </div>
        );

        const Card = ({ icon, title, children, footer }) => {
            const [isOpen, setIsOpen] = useState(true);
            const IconComponent = icon;
            return (
                <div className="bg-white border border-gray-200 rounded-lg shadow-sm">
                    <button 
                        className="w-full flex items-center justify-between p-4 text-left text-gray-700 hover:bg-gray-50 rounded-t-lg" 
                        onClick={() => setIsOpen(!isOpen)}
                    >
                        <div className="flex items-center space-x-3">
                            <IconComponent className="w-5 h-5 text-blue-600" />
                            <h2 className="text-lg font-semibold">{title}</h2>
                        </div>
                        {isOpen ? 
                            <ChevronUp className="w-5 h-5 text-gray-500" /> : 
                            <ChevronDown className="w-5 h-5 text-gray-500" />
                        }
                    </button>
                    {isOpen && (
                        <>
                            <div className="p-4">{children}</div>
                            {footer && (
                                <div className="p-4 bg-gray-50 border-t border-gray-200 rounded-b-lg text-xs text-gray-500">
                                    {footer}
                                </div>
                            )}
                        </>
                    )}
                </div>
            );
        };

        const ApiStatusWidget = () => {
            const [status, setStatus] = useState('checking');
            
            useEffect(() => {
                const checkApiStatus = async () => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/health`);
                        if (response.ok) {
                            setStatus('online');
                        } else {
                            setStatus('error');
                        }
                    } catch (error) {
                        setStatus('offline');
                    }
                };
                
                checkApiStatus();
                const interval = setInterval(checkApiStatus, 10000); // Check every 10 seconds
                return () => clearInterval(interval);
            }, []);

            let statusColor, statusText;
            switch (status) {
                case 'online':
                    statusColor = 'green';
                    statusText = 'API Online';
                    break;
                case 'offline':
                    statusColor = 'red';
                    statusText = 'API Offline';
                    break;
                case 'error':
                    statusColor = 'red';
                    statusText = 'API Error';
                    break;
                default:
                    statusColor = 'yellow';
                    statusText = 'Checking...';
            }
            
            return (
                <div className={`flex items-center space-x-2 p-2 bg-${statusColor}-100 border border-${statusColor}-200 rounded-lg`}>
                    <div className="relative flex items-center justify-center w-4 h-4">
                        <div className={`absolute w-full h-full bg-${statusColor}-400 rounded-full animate-ping opacity-75`}></div>
                        <div className={`w-2.5 h-2.5 bg-${statusColor}-500 rounded-full`}></div>
                    </div>
                    <span className={`text-sm font-semibold text-${statusColor}-800`}>{statusText}</span>
                </div>
            );
        };

        // --- ACCESS CONTROL WIDGET ---
        const AccessControlWidget = () => {
            const [users, setUsers] = useState([]);
            const [tables, setTables] = useState([]);
            const [permissions, setPermissions] = useState({});
            const [selectedUserId, setSelectedUserId] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState('');

            // 1. Fetch users and tables on component mount
            useEffect(() => {
                const fetchData = async () => {
                    try {
                        setIsLoading(true);
                        setError('');
                        console.log('Fetching users and tables...');
                        
                        const [usersRes, tablesRes] = await Promise.all([
                            fetch(`${API_BASE_URL}/api/v1/admin/users`),
                            fetch(`${API_BASE_URL}/api/v1/admin/tables`)
                        ]);
                        
                        if (!usersRes.ok || !tablesRes.ok) {
                            throw new Error(`Failed to fetch initial data. Users: ${usersRes.status}, Tables: ${tablesRes.status}`);
                        }
                        
                        const usersData = await usersRes.json();
                        const tablesData = await tablesRes.json();

                        console.log('Users:', usersData);
                        console.log('Tables:', tablesData);

                        setUsers(usersData);
                        setTables(tablesData);

                        if (usersData.length > 0) {
                            setSelectedUserId(usersData[0].id);
                        }
                    } catch (err) {
                        console.error('Error fetching data:', err);
                        setError(err.message);
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchData();
            }, []);

            // 2. Fetch permissions when selected user changes
            useEffect(() => {
                if (!selectedUserId) return;

                const fetchPermissions = async () => {
                    try {
                        setError('');
                        console.log(`Fetching permissions for user: ${selectedUserId}`);
                        
                        const res = await fetch(`${API_BASE_URL}/api/v1/admin/permissions/${selectedUserId}`);
                        if (!res.ok) throw new Error(`Failed to fetch permissions for ${selectedUserId}. Status: ${res.status}`);
                        
                        const permsData = await res.json();
                        console.log(`Permissions for ${selectedUserId}:`, permsData);
                        
                        setPermissions(perms => ({ ...perms, [selectedUserId]: permsData }));
                    } catch (err) {
                        console.error('Error fetching permissions:', err);
                        setError(err.message);
                    }
                };
                fetchPermissions();
            }, [selectedUserId]);

            // 3. Debounce permission changes to avoid excessive API calls
            const debouncedUpdate = useCallback(
                debounce((newPerms, userId) => {
                    console.log("Sending update to API for user:", userId, newPerms[userId]);
                    fetch(`${API_BASE_URL}/api/v1/admin/permissions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: userId,
                            permissions: newPerms[userId]
                        }),
                    })
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => console.log('Update successful:', data))
                    .catch(err => {
                        console.error('Update failed:', err);
                        setError('Failed to save changes. Please try again.');
                    });
                }, 1000),
                []
            );

            // 4. Handle checkbox clicks
            const handlePermissionChange = (tableName, perm, value) => {
                const newPermissions = {
                    ...permissions,
                    [selectedUserId]: {
                        ...permissions[selectedUserId],
                        [tableName]: {
                            ...(permissions[selectedUserId]?.[tableName] || {}),
                            [perm]: value,
                        },
                    },
                };
                setPermissions(newPermissions);
                debouncedUpdate(newPermissions, selectedUserId);
            };
            
            const selectedUser = useMemo(() => users.find(u => u.id === selectedUserId), [users, selectedUserId]);
            const isChangeDisabled = selectedUser?.role !== 'System Admin' && selectedUser?.role !== 'Tenant Admin';

            if (isLoading) return (
                <Card icon={ShieldCheck} title="Row-Level Security Policy Manager">
                    <div className="text-center p-8">
                        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                        <p className="mt-4">Loading data...</p>
                    </div>
                </Card>
            );
            
            if (error) return (
                <Card icon={ShieldCheck} title="Row-Level Security Policy Manager">
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p className="text-red-500">Error: {error}</p>
                        <button 
                            onClick={() => window.location.reload()} 
                            className="mt-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                        >
                            Retry
                        </button>
                    </div>
                </Card>
            );

            return (
                <Card 
                    icon={ShieldCheck} 
                    title="Row-Level Security Policy Manager" 
                    footer={
                        <p>This interface manages the `user_table_permissions` table. Changes trigger API calls to update PostgreSQL RLS policies. Only Admins can modify permissions.</p>
                    }
                >
                    <div className="space-y-4">
                        <select
                            className="w-full p-2 bg-white border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                            value={selectedUserId}
                            onChange={(e) => setSelectedUserId(e.target.value)}
                        >
                            {users.map(user => (
                                <option key={user.id} value={user.id}>
                                    {user.name} ({user.role})
                                </option>
                            ))}
                        </select>
                        
                        <div className="overflow-x-auto border border-gray-200 rounded-lg">
                            <table className="min-w-full text-sm text-left">
                                <thead className="bg-gray-50 text-gray-600">
                                    <tr>
                                        <th className="p-3 font-semibold">Table Name</th>
                                        <th className="p-3 text-center font-semibold">SELECT</th>
                                        <th className="p-3 text-center font-semibold">INSERT</th>
                                        <th className="p-3 text-center font-semibold">UPDATE</th>
                                        <th className="p-3 text-center font-semibold">DELETE</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {tables.map(table => {
                                        const userPerms = permissions[selectedUserId] || {};
                                        const tablePerms = userPerms[table] || {};
                                        return (
                                            <tr key={table} className="hover:bg-gray-50">
                                                <td className="p-3 font-medium text-gray-900">{table}</td>
                                                {['can_select', 'can_insert', 'can_update', 'can_delete'].map(perm => (
                                                    <td key={perm} className="p-3 text-center">
                                                        <input
                                                            type="checkbox"
                                                            className="w-5 h-5 bg-gray-100 border-gray-300 rounded text-blue-600 focus:ring-blue-500 cursor-pointer disabled:cursor-not-allowed disabled:opacity-50"
                                                            checked={!!tablePerms[perm]}
                                                            onChange={(e) => handlePermissionChange(table, perm, e.target.checked)}
                                                            disabled={isChangeDisabled}
                                                        />
                                                    </td>
                                                ))}
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                        {isChangeDisabled && (
                            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                <p className="text-sm text-yellow-800 flex items-center">
                                    <AlertTriangle className="inline w-4 h-4 mr-2" />
                                    Permission changes are disabled for this user role. Only System Admin and Tenant Admin users can modify permissions.
                                </p>
                            </div>
                        )}
                    </div>
                </Card>
            );
        };

        // --- OTHER WIDGETS ---
        const SyncLogWidget = () => (
            <Card 
                icon={Activity} 
                title="Real-Time Sync Log" 
                footer={<p>Monitoring real-time activity on the <strong>POST /api/v1/sync</strong> endpoint.</p>}
            >
                <div className="text-center p-8 text-gray-500">
                    <Activity className="w-12 h-12 mx-auto mb-4 text-gray-300" />
                    <p>Coming Soon</p>
                    <p className="text-sm mt-2">Real-time sync monitoring will be displayed here</p>
                </div>
            </Card>
        );

        const DbOperationsWidget = () => (
            <Card 
                icon={Database} 
                title="Database Management" 
                footer={<p>Cloning creates a sanitized copy of the production database for development or testing.</p>}
            >
                <div className="text-center p-8 text-gray-500">
                    <Database className="w-12 h-12 mx-auto mb-4 text-gray-300" />
                    <p>Coming Soon</p>
                    <p className="text-sm mt-2">Database management tools will be available here</p>
                </div>
            </Card>
        );

        // --- UTILITY FUNCTIONS ---
        function debounce(fn, delay) {
            let timeoutId;
            return function(...args) {
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }
                timeoutId = setTimeout(() => {
                    fn(...args);
                }, delay);
            };
        }

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
